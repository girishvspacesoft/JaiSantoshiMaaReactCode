import{r as s,a as t}from"./react-bfabd40c.js";import{u as re,a as pe}from"./react-redux-45d870ba.js";import{L as ve,A as ge,D as he}from"./x-date-pickers-7b1cc7dd.js";import"./Card.module-3bdbfb7f.js";import{bY as Ne,bZ as fe,bq as ue,b_ as xe,b3 as qe,b4 as Ae,a4 as de,L as be,b$ as we,c0 as je,c1 as De,c2 as _e,c3 as Me,b5 as Pe,c4 as Ie,al as Fe,c5 as ye,c6 as Te}from"./index-60b53c60.js";import{c as Oe,h as Re,i as ze,j as We}from"./icons-material-4539f19e.js";import{S as Le}from"./SendEmail-4c230401.js";import{u as He,D as ke,G as Ye}from"./x-data-grid-cceece3f.js";import{j as $e}from"./utils-c03c978f.js";import{O as Ce,Q as Se,h as p,m as Q,f as oe,a as Ve,i as q,A as U,D as ce,V as T,l as Ge}from"./material-e0a59a28.js";import"./@babel-e11bafe1.js";import"./react-dom-b0178e93.js";import"./scheduler-765c72db.js";import"./hoist-non-react-statics-6cfbf744.js";import"./use-sync-external-store-18921cc2.js";import"./@date-io-f382d426.js";import"./dayjs-7f45ce31.js";import"./clsx-1229b3e0.js";import"./base-ff50cfe3.js";import"./@popperjs-f3391c26.js";import"./rifm-7b0f12ad.js";import"./system-a1d29c52.js";import"./styled-engine-f3bd09bf.js";import"./@emotion-77835cc8.js";import"./stylis-79144faa.js";import"./private-theming-970ac73c.js";import"./react-transition-group-7ded6f4d.js";import"./dom-helpers-9a525042.js";import"./redux-persist-d9cc1560.js";import"./redux-b7ba668d.js";import"./@reduxjs-4d37e7cf.js";import"./immer-41fd5235.js";import"./redux-thunk-ef899f4c.js";import"./axios-4a70c6fc.js";import"./react-router-1b5f20a2.js";import"./@remix-run-d753ad9e.js";import"./react-router-dom-4405dfe9.js";import"./react-icons-55b3b9a0.js";import"./prop-types-d7fd566a.js";import"./reselect-36a88051.js";const Ue=({bills:d})=>{const v=[{field:"_id",headerName:"Id"},{field:"billNo",headerName:"Bill no.",flex:1},{field:"billDate",headerName:"Bill date",flex:1},{field:"billAmount",headerName:"Total bill amount",type:"number",flex:1},{field:"receivedAmout",headerName:"Receiving amount",type:"number",flex:1},{field:"payMode",headerName:"Payment mode",flex:1},{field:"receivingDate",headerName:"Receiving date",flex:1},{field:"actions",headerName:"Action",sortable:!1,minWidth:180,renderCell:r=>{const g=S=>{var b,u,B;S.stopPropagation();const F=(B=(u=((b=d==null?void 0:d.find)==null?void 0:b.call(d,x=>x._id===r.row.bill_id)).paymentCollection)==null?void 0:u.findIndex)==null?void 0:B.call(u,x=>x._id===r.row._id);P({...r.row,download:!1,index:F+1})},C=S=>{var b,u,B;S.stopPropagation();const F=(B=(u=((b=d==null?void 0:d.find)==null?void 0:b.call(d,x=>x._id===r.row.bill_id)).paymentCollection)==null?void 0:u.findIndex)==null?void 0:B.call(u,x=>x._id===r.row._id);P({...r.row,download:!0,index:F+1})},f=S=>{S.stopPropagation(),R(!0),k({...r.row})};return t.createElement(t.Fragment,null,t.createElement(oe,{size:"small",onClick:C,color:"primary"},t.createElement(Re,null)),t.createElement(oe,{size:"small",onClick:g,color:"primary"},t.createElement(ze,null)),t.createElement(oe,{size:"small",onClick:f,color:"primary"},t.createElement(We,null)))}}],{search:A}=re(({paymentcollection:r})=>r),H=He(),M=pe(),Y=re(Ne),[m,Z]=s.useState([]),[D,J]=s.useState(null),[_,O]=s.useState(""),[N,R]=s.useState(!1),[z,h]=s.useState(!1),[i,K]=s.useState(""),[l,k]=s.useState(null),[ie,X]=s.useState(!1);s.useEffect(()=>{Z(()=>le(d))},[d]);const P=r=>{J(r)},ee=s.useMemo(()=>$e(r=>{var g,C,f;H.current.setQuickFilterValues((f=(C=(g=r.split)==null?void 0:g.call(r," "))==null?void 0:C.filter)==null?void 0:f.call(C,S=>S!==""))},500),[H]);s.useEffect(()=>{A&&(m!=null&&m.length)&&(X(!0),ee(A),setTimeout(()=>{X(!1)},500))},[m]);const se=r=>{ee(r.target.value),M(we(r.target.value))};s.useEffect(()=>{D&&M(fe({billId:D.bill_id,collectionId:D._id,email:""})).then(({payload:r={}})=>{const{message:g}=(r==null?void 0:r.data)||{};if(g)O(g);else{if(O(""),r!=null&&r.data.file){const C=`${ue(D.billNo)}_${xe(D.index,3)}.pdf`,f=qe(r==null?void 0:r.data.file);D.download?Ae(f,C):window.open(f,"_blank")}J(null)}}).catch(()=>{O("Something went wrong! Please try later or contact Administrator.")})},[D]),s.useEffect(()=>{z&&i&&l&&(R(!1),M(fe({billId:l.bill_id,collectionId:l._id,email:i})).then(({payload:r={}})=>{const{message:g}=(r==null?void 0:r.data)||{};g&&O(g),h(!1),k(null)}).catch(r=>{O(r.message),k(null)}))},[z,i,l]);const le=r=>{var C;const g=[];return r!=null&&r.length&&((C=r==null?void 0:r.forEach)==null||C.call(r,f=>{var S,I,F;(S=f.paymentCollection)!=null&&S.length&&((F=(I=f.paymentCollection)==null?void 0:I.forEach)==null||F.call(I,b=>{var B,x,W,$,e;const u={};u._id=b._id,u.bill_id=f._id,u.billNo=ue(f.billNo),u.billDate=de(f.date),u.billAmount=(x=(B=f.total)==null?void 0:B.toFixed)==null?void 0:x.call(B,2),u.receivingDate=de(b.receivingDate),u.receivedAmout=($=(W=b.receive)==null?void 0:W.toFixed)==null?void 0:$.call(W,2),u.payMode=b.payMode,(e=g==null?void 0:g.push)==null||e.call(g,u)}))})),g},te=r=>{h(!0),K(r)};return t.createElement(t.Fragment,null,(Y||ie)&&t.createElement(be,null),t.createElement("h2",{className:"mb20"},"Collection history"),_!==""&&t.createElement(Ce,{sx:{width:"100%",margin:"0 0 30px 0",border:"1px solid red",borderRadius:"4px"},spacing:2},t.createElement(Se,{severity:"error"},_)),t.createElement(ke,{apiRef:H,sx:{backgroundColor:"primary.contrastText"},autoHeight:!0,density:"standard",getRowId:r=>r._id,rows:m,columns:v,initialState:{...v,columns:{columnVisibilityModel:{_id:!1}}},components:{Toolbar:()=>t.createElement(Ye,{sx:{gap:"6px",mb:"10px",justifyContent:"end",border:"none"}},t.createElement(p,{variant:"standard",placeholder:"Search...",autoFocus:!!A,onChange:se,value:A,InputProps:{startAdornment:t.createElement(Q,{position:"start"},t.createElement(Oe,null))}}))},pageSize:10,rowsPerPageOptions:[10],disableSelectionOnClick:!0}),t.createElement(Le,{isOpen:N,setIsOpen:R,handleEmailClose:()=>{R(!1)},handleSendEmail:r=>te(r),contentBody:""}))},Ee={branch:"",customer:"",receivingDate:new Date,totalReceivable:"",totalReceived:"",receivedToday:"",payMode:null,bankName:"",chequeNo:"",chequeDate:null,jsmBank:null,jsmAccountNo:null},me={receivingDate:{invalid:!1,message:""},receivedToday:{invalid:!1,message:""},payMode:{invalid:!1,message:""},bankName:{invalid:!1,message:""},chequeNo:{invalid:!1,message:""},chequeDate:{invalid:!1,message:""},jsmBank:{invalid:!1,message:""},jsmAccountNo:{invalid:!1,message:""}},Qe=(d,v)=>{var M,Y;const A=(M=d==null?void 0:d.filter)==null?void 0:M.call(d,m=>m.receive);return(Y=A==null?void 0:A.map)==null?void 0:Y.call(A,m=>(m.receive&&(m.payment={bankName:v.bankName,chequeDate:v.chequeDate,chequeNo:v.chequeNo,payMode:v.payMode.value,jsmBank:v.jsmBank?v.jsmBank.value:"",jsmAccountNo:v.jsmAccountNo?v.jsmAccountNo.value:"",receive:+m.receive,receivingDate:v.receivingDate}),m))},yt=()=>{var u,B,x,W,$;const d=[{field:"_id",headerName:"Id"},{field:"billNo",headerName:"Bill no.",flex:1,renderCell:e=>ue(e.row.billNo)},{field:"date",headerName:"Bill date",flex:1,renderCell:e=>de(new Date(e.row.date))},{field:"total",headerName:"Total bill amount",type:"number",flex:1,renderCell:e=>{var a,n;return t.createElement("strong",null,"₹ ",(n=(a=e.row.total)==null?void 0:a.toFixed)==null?void 0:n.call(a,2))}},{field:"received",headerName:"Received",flex:1,type:"number",renderCell:e=>{var a,n;return t.createElement("strong",null,"₹ ",(n=(a=+e.row.received).toFixed)==null?void 0:n.call(a,2))}},{field:"balance",headerName:"Balance",flex:1,type:"number",renderCell:e=>{var a,n;return t.createElement("strong",null,"₹ ",(n=(a=+e.row.balance).toFixed)==null?void 0:n.call(a,2))}},{field:"receive",headerName:"Receive",flex:1,renderCell:e=>t.createElement(q,{fullWidth:!0,className:"tableTextfield"},t.createElement(p,{size:"small",variant:"outlined",value:e.row.receive||"",onChange:C.bind(null,"amount"),onInput:Fe,name:e.row._id,id:`${e.row._id}_amount`,InputProps:{startAdornment:t.createElement(Q,{position:"start"},"₹")}}))}],v=pe(),A=re(Ne),H=re(e=>e.user),[M,Y]=s.useState([]),[m,Z]=s.useState({_id:""}),[D,J]=s.useState([]),[_,O]=s.useState(""),[N,R]=s.useState([]),[z,h]=s.useState(""),[i,K]=s.useState(me),[l,k]=s.useState(Ee),[ie,X]=s.useState([]),[P,ee]=s.useState([]),[se,le]=s.useState([]);s.useEffect(()=>{v(je()).then(({payload:e={}})=>{var n,o;const{message:a}=(e==null?void 0:e.data)||{};if(a)h(a);else{Y(e==null?void 0:e.data);const E=(o=(n=e==null?void 0:e.data)==null?void 0:n.find)==null?void 0:o.call(n,c=>c._id===H.branch);Z(E)}}).catch(()=>{h("Something went wrong! Please try later or contact Administrator.")}),v(De()).then(({payload:e={}})=>{var n,o;const{message:a}=(e==null?void 0:e.data)||{};if(a)h(a);else{const E=(o=(n=e==null?void 0:e.data)==null?void 0:n.map)==null?void 0:o.call(n,c=>({...c,label:c.name,value:c.name}));X(E)}}).catch(()=>{h("Something went wrong! Please try later or contact Administrator.")}),v(_e()).then(({payload:e={}})=>{var n,o;const{message:a}=(e==null?void 0:e.data)||{};if(a)h(a);else{const E=(o=(n=e==null?void 0:e.data)==null?void 0:n.map)==null?void 0:o.call(n,c=>({...c,label:c.accountNo,value:c.accountNo}));ee(E)}}).catch(()=>{h("Something went wrong! Please try later or contact Administrator.")})},[]),s.useEffect(()=>{const e=Object.keys(i);if(e!=null&&e.length){const a=document.querySelector(`input[name=${e[1]}]`);a==null||a.scrollIntoView({behavior:"smooth",block:"center",inline:"start"})}},[i]),s.useEffect(()=>{if(z){const e=document.getElementById("alertError");e==null||e.scrollIntoView({behavior:"smooth",block:"center",inline:"start"})}},[z]),s.useEffect(()=>{m&&m._id&&v(Me(m._id)).then(({payload:e={}})=>{const{message:a}=(e==null?void 0:e.data)||{};a?h(a):(h(""),J(e==null?void 0:e.data))}).catch(()=>{h("Something went wrong! Please try later or contact Administrator.")})},[m]);const te=()=>{v(ye({customer:_==null?void 0:_._id,branch:m==null?void 0:m._id})).then(({payload:e={}})=>{var n,o,E;const{message:a}=(e==null?void 0:e.data)||{};if(a)h(a);else{h("");const c=(o=(n=e==null?void 0:e.data)==null?void 0:n.map)==null?void 0:o.call(n,w=>{var L,G;const V=(G=(L=w.paymentCollection)==null?void 0:L.reduce)==null?void 0:G.call(L,(ae,ne)=>ae+ne.receive,0);return{...w,receive:"",received:V,balance:w.total-V,field:t.createElement(p,null)}});R(c);let y=0,j=0;(E=c==null?void 0:c.forEach)==null||E.call(c,w=>{y+=+w.total,j+=+w.received}),k(w=>({...w,totalReceivable:y,totalReceived:j}))}}).catch(()=>{h("Something went wrong! Please try later or contact Administrator.")})};s.useEffect(()=>{_&&m&&te()},[_,m]),s.useEffect(()=>{var a;let e=0;(a=N==null?void 0:N.forEach)==null||a.call(N,n=>{e+=+n.receive}),k(n=>({...n,receivedToday:e}))},[N]),s.useEffect(()=>{l.jsmBank&&l.jsmBank._id&&le(()=>{var e;return(e=P==null?void 0:P.filter)==null?void 0:e.call(P,a=>a.bank===l.jsmBank._id)})},[l.jsmBank]);const r=(e,a)=>{Z(a)},g=(e,a)=>{O(a)},C=(e,a)=>{const n=a.target.name,o=a.target.value;R(E=>{var y;const c=[...E];return(y=c==null?void 0:c.forEach)==null||y.call(c,j=>{j._id===n&&e==="amount"&&(j.receive=o)}),c})},f=e=>{const a=e.target.name,n=e.target.value;k(o=>({...o,[a]:n})),a==="payMode"&&k(o=>({...o,bankName:"",chequeNo:"",chequeDate:null,jsmBank:"",jsmAccountNo:""}))},S=(e,a)=>{k(e==="receivingDate"?n=>({...n,date:new Date(a)}):n=>({...n,chequeDate:new Date(a)}))},I=e=>{if(e.preventDefault(),!F(l)){const a=Qe(N,l);v(Te(a)).then(({payload:n={}})=>{const{message:o}=(n==null?void 0:n.data)||{};o?h(o):(h(""),K(me),te(),k(Ee))}).catch(n=>{h(n.message)})}},F=e=>{var o,E,c,y,j,w,V,L,G,ae,ne;const a={...me};e.receivingDate||(a.receivingDate={invalid:!0,message:"Date is required"}),+e.receivedToday==0&&(a.receivedToday={invalid:!0,message:"Received should be greater than 0"}),e.payMode||(a.payMode={invalid:!0,message:"Payment mode is required"}),((o=e.payMode)==null?void 0:o.value)==="Cheque"&&!((c=(E=e.bankName)==null?void 0:E.trim)!=null&&c.call(E))&&(a.bankName={invalid:!0,message:"Bank name is required"}),((y=e.payMode)==null?void 0:y.value)==="Cheque"&&!((w=(j=e.chequeNo)==null?void 0:j.trim)!=null&&w.call(j))&&(a.chequeNo={invalid:!0,message:"Cheque number is required"}),((V=e.payMode)==null?void 0:V.value)==="Cheque"&&!e.chequeDate&&(a.chequeDate={invalid:!0,message:"Cheque date is required"}),((L=e.payMode)==null?void 0:L.value)==="Cheque"&&(e.jsmBank||(a.jsmBank={invalid:!0,message:"Bank is required"}),e.jsmAccountNo||(a.jsmAccountNo={invalid:!0,message:"Account is required"})),(((G=e.payMode)==null?void 0:G.value)==="Cheque"||((ae=e.payMode)==null?void 0:ae.value)==="NEFT/RTGS"||((ne=e.payMode)==null?void 0:ne.value)==="Online banking")&&(e.jsmBank||(a.jsmBank={invalid:!0,message:"Bank is required"}),e.jsmAccountNo||(a.jsmAccountNo={invalid:!0,message:"Account is required"}));let n=!1;for(const Be in a)a[Be].invalid===!0&&(n=!0);return n&&K(a),n},b=(e,a,n)=>{k(n==="jsmBank"?o=>({...o,[n]:a,jsmAccountNo:null}):o=>({...o,[n]:a}))};return t.createElement(t.Fragment,null,A&&t.createElement(be,null),t.createElement("div",{className:"page_head"},t.createElement("h1",{className:"pageHead"},"Payment collection")),t.createElement("div",{className:"inner-wrap"},z!==""&&t.createElement(Ce,{sx:{width:"100%",margin:"0 0 30px 0",border:"1px solid red",borderRadius:"4px"},spacing:2},t.createElement(Se,{id:"alertError",severity:"error"},z)),t.createElement(Ve,{sx:{padding:"20px",marginBottom:"20px"}},t.createElement("div",{className:"grid grid-6-col"},t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,size:"small"},t.createElement(U,{disablePortal:!0,size:"small",name:"branch",options:M,value:m||null,disabled:!Pe(),onChange:r,getOptionLabel:e=>e.name||"",openOnFocus:!0,renderInput:e=>t.createElement(p,{...e,label:"Select branch",fullWidth:!0})}))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,size:"small"},t.createElement(U,{disablePortal:!0,size:"small",name:"customer",options:D,value:_||null,onChange:g,getOptionLabel:e=>e.name||"",openOnFocus:!0,renderInput:e=>t.createElement(p,{...e,label:"Select customer",fullWidth:!0})})))),t.createElement(ce,{sx:{margin:"20px 0"}}),t.createElement("form",{action:"",onSubmit:I},t.createElement(ke,{sx:{backgroundColor:"primary.contrastText"},autoHeight:!0,density:"standard",getRowId:e=>e._id,rows:N,columns:d,initialState:{...d,columns:{columnVisibilityModel:{_id:!1}}},pageSize:10,rowsPerPageOptions:[10],disableSelectionOnClick:!0}),t.createElement(ce,{sx:{margin:"20px 0"}}),(N==null?void 0:N.length)>0&&t.createElement(ce,{sx:{margin:"20px 0"}})&&t.createElement(t.Fragment,null,t.createElement("div",{className:"grid grid-6-col"},t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,error:i.receivingDate.invalid},t.createElement(ve,{dateAdapter:ge},t.createElement(he,{error:i.receivingDate.invalid,label:"Date",inputFormat:"DD/MM/YYYY",value:l.receivingDate,disableFuture:!0,onChange:S.bind(null,"receivingDate"),inputProps:{readOnly:!0},renderInput:e=>t.createElement(p,{name:"receivingDate",size:"small",...e,error:i.receivingDate.invalid})})),i.receivingDate.invalid&&t.createElement(T,null,i.receivingDate.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0},t.createElement(p,{size:"small",variant:"outlined",label:"Total receivable",value:l.totalReceivable,name:"totalReceivable",id:"totalReceivable",InputProps:{readOnly:!0,startAdornment:t.createElement(Q,{position:"start"},"₹")}}))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0},t.createElement(p,{size:"small",variant:"outlined",label:"Total received",value:l.totalReceived,name:"totalReceived",id:"totalReceived",InputProps:{readOnly:!0,startAdornment:t.createElement(Q,{position:"start"},"₹")}}))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,error:i.receivedToday.invalid},t.createElement(p,{size:"small",variant:"outlined",label:"Received today",value:l.receivedToday,error:i.receivedToday.invalid,name:"receivedToday",id:"receivedToday",InputProps:{readOnly:!0,startAdornment:t.createElement(Q,{position:"start"},"₹")}}),i.receivedToday.invalid&&t.createElement(T,null,i.receivedToday.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,size:"small",error:i.payMode.invalid},t.createElement(U,{disablePortal:!0,autoSelect:!0,size:"small",name:"payMode",options:Ie,value:l.payMode,onChange:(e,a)=>b(e,a,"payMode"),openOnFocus:!0,renderInput:e=>t.createElement(p,{...e,label:"Payment mode",error:i.payMode.invalid,fullWidth:!0})}),i.payMode.invalid&&t.createElement(T,null,i.payMode.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,error:i.bankName.invalid},t.createElement(p,{size:"small",variant:"outlined",label:"Bank name",value:l.bankName,error:i.bankName.invalid,name:"bankName",id:"bankName",onChange:f,disabled:((u=l.payMode)==null?void 0:u.value)!=="Cheque"}),i.bankName.invalid&&t.createElement(T,null,i.bankName.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,error:i.chequeNo.invalid},t.createElement(p,{size:"small",variant:"outlined",label:"Cheque no",value:l.chequeNo,error:i.chequeNo.invalid,name:"chequeNo",id:"chequeNo",onChange:f,disabled:((B=l.payMode)==null?void 0:B.value)!=="Cheque"}),i.chequeDate.invalid&&t.createElement(T,null,i.chequeNo.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,error:i.chequeDate.invalid},t.createElement(ve,{dateAdapter:ge},t.createElement(he,{error:i.chequeDate.invalid,label:"Cheque date",disabled:((x=l.payMode)==null?void 0:x.value)!=="Cheque",inputFormat:"DD/MM/YYYY",value:l.chequeDate,disableFuture:!0,onChange:S.bind(null,"chequeDate"),inputProps:{readOnly:!0},renderInput:e=>t.createElement(p,{name:"date",size:"small",...e,error:i.chequeDate.invalid})})),i.chequeDate.invalid&&t.createElement(T,null,i.chequeDate.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,size:"small",error:i.jsmBank.invalid},t.createElement(U,{disablePortal:!0,autoSelect:!0,size:"small",name:"jsmBank",options:ie,value:l.jsmBank,disabled:!l.payMode||((W=l.payMode)==null?void 0:W.value)==="Cash",onChange:(e,a)=>b(e,a,"jsmBank"),openOnFocus:!0,renderInput:e=>t.createElement(p,{...e,label:"Bank",error:i.jsmBank.invalid,fullWidth:!0})}),i.jsmBank.invalid&&t.createElement(T,null,i.jsmBank.message))),t.createElement("div",{className:"grid-item"},t.createElement(q,{fullWidth:!0,size:"small",error:i.jsmAccountNo.invalid},t.createElement(U,{disablePortal:!0,autoSelect:!0,size:"small",name:"jsmAccountNo",options:se,value:l.jsmAccountNo,disabled:!l.payMode||(($=l.payMode)==null?void 0:$.value)==="Cash",onChange:(e,a)=>b(e,a,"jsmAccountNo"),openOnFocus:!0,renderInput:e=>t.createElement(p,{...e,label:"Account no.",error:i.jsmAccountNo.invalid,fullWidth:!0})}),i.jsmAccountNo.invalid&&t.createElement(T,null,i.jsmAccountNo.message)))),t.createElement("div",{className:"right"},t.createElement(Ge,{variant:"contained",size:"medium",type:"submit",color:"primary",className:"ml6"},"Save"))))),t.createElement(Ue,{bills:N})))};export{yt as default};
